name: "Build: Ubuntu"

on:
  workflow_dispatch:
  pull_request:
    branches:
      - master
      - develop
    paths:
      - "data/**"
      - "mods/**" 
      - "modules/**"
      - "layouts/**"
      - ".github/**"
      - "src/**"
  push:
    branches:
      - master
      - develop
    paths:
      - "data/**"
      - "mods/**"
      - "modules/**"
      - "layouts/**"
      - "src/**"

env:
  CMAKE_BUILD_PARALLEL_LEVEL: 2
  MAKEFLAGS: '-j 2'
  VCPKG_DEFAULT_BINARY_CACHE: ${{ github.workspace }}/vcpkg/bincache
  VCPKG_BINARY_SOURCES: 'clear;default,readwrite'

jobs:
  build:
    name: ${{ matrix.os }}-${{ matrix.buildtype }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-22.04
            buildtype: linux-release
            triplet: x64-linux
            artifact-name: otclient
            packages: sccache

    steps:
    - name: Checkout repository
      uses: actions/checkout@main

    - name: Install Linux Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libgl1-mesa-dev xorg-dev libasound2-dev libglu1-mesa-dev freeglut3-dev mesa-common-dev

    - name: Cache vcpkg packages
      uses: actions/cache@v3
      with:
        path: |
          ${{ github.workspace }}/vcpkg
          !${{ github.workspace }}/vcpkg/buildtrees
          !${{ github.workspace }}/vcpkg/packages
          !${{ github.workspace }}/vcpkg/downloads
          !${{ github.workspace }}/vcpkg/installed  # Add this line
        key: vcpkg-${{ runner.os }}-${{ hashFiles('vcpkg.json') }}
        restore-keys: |
          vcpkg-${{ runner.os }}-

    - name: Cache build outputs
      uses: actions/cache@v3
      with:
        path: |
          ${{ github.workspace }}/build/${{ matrix.buildtype }}
          !${{ github.workspace }}/build/${{ matrix.buildtype }}/CMakeCache.txt
          !${{ github.workspace }}/build/${{ matrix.buildtype }}/CMakeFiles
        key: build-${{ runner.os }}-${{ matrix.buildtype }}-${{ hashFiles('src/**/*.cpp', 'src/**/*.h') }}
        restore-keys: |
          build-${{ runner.os }}-${{ matrix.buildtype }}-

    - name: Create vcpkg binary cache directory
      run: mkdir -p ${{ env.VCPKG_DEFAULT_BINARY_CACHE }}

    - name: Setup vcpkg
      uses: lukka/run-vcpkg@v11
      with:
        vcpkgDirectory: '${{ github.workspace }}/vcpkg'
      env:
        VCPKG_DEFAULT_TRIPLET: ${{ matrix.triplet }}

    - name: Restore artifacts and install vcpkg
      id: vcpkg-step-unix
      shell: bash
      run: |
        vcpkgCommitId=$(cat vcpkg.json | grep -o '"builtin-baseline": *"[^"]*"' | cut -d'"' -f4)
        echo "vcpkg commit ID: $vcpkgCommitId"
        echo "vcpkgGitCommitId=$vcpkgCommitId" >> $GITHUB_OUTPUT

    - name: Get latest CMake and Ninja
      uses: lukka/get-cmake@latest
      with:
        ninjaVersion: latest 

    - name: Run CMake
      uses: lukka/run-cmake@v10
      with:
        configurePreset: '${{ matrix.buildtype }}'
        buildPreset: '${{ matrix.buildtype }}'

    - name: Create and Upload Artifacts
      uses: actions/upload-artifact@main
      with:
        name: otclient-${{ matrix.os }}-${{ matrix.buildtype }}-${{ github.sha }}
        path: |
          ${{ github.workspace }}/build/${{ matrix.buildtype }}/${{ matrix.artifact-name }}

    - name: Create Client Package (Linux)
      run: |
        mkdir -p client
        cp -r data client/
        cp -r mods client/
        cp -r modules client/
        cp init.lua client/
        cp build/${{ matrix.buildtype }}/otclient client/
        chmod +x client/otclient
        tar -czf client.tar.gz client/

    - name: Upload Client Package
      uses: actions/upload-artifact@v4
      with:
        name: client-${{ matrix.os }}-${{ matrix.buildtype }}
        path: |
          ${{ 'client.tar.gz' }}
